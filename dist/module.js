define(["lodash","app/plugins/sdk"],(function(e,t){return n={},a.m=r=[function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnnotationsQueryCtrl=t.QueryOptionsCtrl=t.ConfigCtrl=t.QueryCtrl=t.Datasource=void 0;var r=a(1),n=a(3),u=a(5),o=a(6),i=a(7);t.Datasource=r.DarkSkyDatasource,t.QueryCtrl=n.DarkSkyQueryCtrl,t.ConfigCtrl=u.DarkSkyConfigCtrl,t.QueryOptionsCtrl=o.DarkskyQueryOptionsCtrl,t.AnnotationsQueryCtrl=i.DarkSkyAnnotationCtrl},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DarkSkyDatasource=void 0;var r,n=(r=a(2))&&r.__esModule?r:{default:r},u=(o.$inject=["instanceSettings","backendSrv","templateSrv","$q"],o.prototype.metricFindQuery=function(e){var t=this;return this.metrics?this.metrics:this.doRequest({query:e,url:this.apiUrl+"/"+this.lat+", "+this.lon,method:"GET"}).then((function(e){var a=n.default.transform(["currently","hourly","daily"],(function(t,a){var r=e.data[a];r&&n.default.isArray(r.data)&&(r=r.data.length?r.data[0]:{}),t.push.apply(t,n.default.filter(n.default.keys(r),(function(e){return"time"!==e})))}),[]);return t.metrics=n.default.map(n.default.uniq(n.default.sortBy(a)),(function(e){return{text:e,value:e}})),t.metrics}))},o.prototype.query=function(e){var t=this,a=this.buildQueryParameters(e);if(a.targets=a.targets.filter((function(e){return!e.hide})),a.targets.length<=0)return this.$q.when({data:[]});this.templateSrv.getAdhocFilters?a.adhocFilters=this.templateSrv.getAdhocFilters(this.datasourceName):a.adhocFilters=[];var r=this.getApiCalls(a.range,a.maxDataPoints),u=this.lon,o=this.lat;e&&e.targets&&(u=e.targets[0].lon,o=e.targets[0].lat);var i=this.apiUrl+"/"+o+","+u,s=n.default.map(r.timestamps,(function(e){return t.doRequest({query:a,url:i+","+e+"?"+t.apiOptions,method:"GET"})}));return 10<=r.timestamps.length&&console.warn("DarkSky will execute "+r.timestamps.length+" api."),Promise.all(s).then((function(e){var u=n.default.transform(e,(function(e,t){var u=n.default.get(t,"data."+r.dataset);"currently"!==r.dataset?e.push.apply(e,n.default.filter(u.data,(function(e){var t=1e3*e.time;return t>=a.range.from&&t<=a.range.to}))):e.push(u)}),[]);return u=n.default.sortBy(u,"time"),n.default.filter(a.targets,{type:"table"}).length?t.tableResponse(a.targets,u):t.timeseriesResponse(a.targets,u)}))},o.prototype.getApiCalls=function(e,t){var a="hourly",r=1,n=e.to.diff(e.from,"hours"),u=e.from.clone().startOf("day"),o=[u.unix()];if(e.to.date()!==e.from.date()){if(168<n&&(a="daily",t)){var i=e.to.diff(e.from,"days");r=Math.max(r,Math.floor(i/t))}for(u.add(r,"day");u.isBefore(e.to);)o.push(u.unix()),u.add(r,"day")}return{dataset:a,timestamps:o}},o.prototype.tableResponse=function(e,t){var a=n.default.map(n.default.head(t),(function(e,t){return{text:t,type:t.match(/[Tt]ime/)?"time":"string"==typeof e?"string":"number"}})),r=n.default.map(t,(function(e){return n.default.map(a,(function(t){return void 0===e[t.text]?null:"time"===t.type?1e3*e[t.text]:e[t.text]}))}));return{data:[{type:"table",columns:a,rows:r}]}},o.prototype.timeseriesResponse=function(e,t){return{data:n.default.map(e,(function(e){return{target:e.target,datapoints:n.default.map(t,(function(t){return[t[e.target],1e3*t.time]}))}}))}},o.prototype.buildQueryParameters=function(e){var t=this;return e.targets=n.default.filter(e.targets,(function(e){return"select metric"!==e.target})),e.targets=n.default.map(e.targets,(function(a){return{target:t.templateSrv.replace(a.target,e.scopedVars,"regex"),refId:a.refId,hide:a.hide,type:a.type,lon:a.lon,lat:a.lat}})),e},o.prototype.testDatasource=function(){return this.doRequest({}).then((function(e){return 200===e.status?{status:"success",message:"Data source is working",title:"Success"}:{status:"error",message:"Data source returned status "+e.status,title:"Error"}}))},o.prototype.doRequest=function(e){var t=this.apiUrl+"/"+this.lat+", "+this.lon;return e&&(e.url||(console.log("set default url, since no url is given"),e.url=t)),this.backendSrv.datasourceRequest(e).then((function(e){var t=n.default.get(e,"headers");if(t){var a;600<(a="function"==typeof t?(t=t(),n.default.get(t,"x-forecast-api-calls")):t.get("x-forecast-api-calls"))&&console.warn("DarkSky noticed you've already executed "+a+" api calls. Free limit is 1000.")}else console.warn("No headers found!");return e}))},o.prototype.annotationQuery=function(e){throw new Error("Annotation Support not implemented yet.")},o);function o(e,t,a,r){this.backendSrv=t,this.templateSrv=a,this.$q=r,this.datasourceName=e.name;var n=e.jsonData;this.lat=n.lat,this.lon=n.lon;var u=""+n.apikey;this.apiUrl="/api/datasources/proxy/"+e.id+"/darksky/"+u,this.apiOptions="units="+n.unit+"&lang="+n.language}t.DarkSkyDatasource=u},function(t,a){t.exports=e},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DarkSkyQueryCtrl=void 0;var r,n,u=a(4),o=((r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)},function(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)})(i,n=u.QueryCtrl),i.$inject=["$scope","$injector","templateSrv"],i.prototype.getOptions=function(e){return this.datasource.metricFindQuery(this.target.type)},i.prototype.refresh=function(){this.panelCtrl.refresh()},i.templateUrl="partials/query.editor.html",i);function i(e,t,a){var r=n.call(this,e,t)||this;return r.templateSrv=a,r.types=[{text:"Time series",value:"timeseries"},{text:"Table",value:"table"}],r.target.target=r.target.target||"select metric",r.target.type=r.target.type||("table"===r.panelCtrl.panel.type?"table":"timeseries"),r.target.lon=r.target.lon||r.datasource.lon,r.target.lat=r.target.lat||r.datasource.lat,r}t.DarkSkyQueryCtrl=o},function(e,a){e.exports=t},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/config.html",n);function n(e){console.debug("DarkSkyConfigCtrl"),this.units=[{name:"SI",value:"si"},{name:"Auto",value:"auto"},{name:"US",value:"us"},{name:"CA",value:"ca"},{name:"UK",value:"uk2"}],this.languages=[{name:"Arabic",value:"ar"},{name:"Azerbaijani",value:"az"},{name:"Belarusian",value:"be"},{name:"Bulgarian",value:"bg"},{name:"Bosnian",value:"bs"},{name:"Catalan",value:"ca"},{name:"Czech",value:"cs"},{name:"Danish",value:"da"},{name:"German",value:"de"},{name:"Greek",value:"el"},{name:"English",value:"en"},{name:"Spanish",value:"es"},{name:"Estonian",value:"et"},{name:"Finnish",value:"fi"},{name:"French",value:"fr"},{name:"Hebrew",value:"he"},{name:"Croatian",value:"hr"},{name:"Hungarian",value:"hu"},{name:"Indonesian",value:"id"},{name:"Icelandic",value:"is"},{name:"Italian",value:"it"},{name:"Japanese",value:"ja"},{name:"Georgian",value:"ka"},{name:"Korean",value:"ko"},{name:"Cornish",value:"kw"},{name:"Norwegian",value:"nb"},{name:"Dutch",value:"nl"},{name:"Polish",value:"pl"},{name:"Portuguese",value:"pt"},{name:"Romanian",value:"ro"},{name:"Russian",value:"ru"},{name:"Slovak",value:"sk"},{name:"Slovenian",value:"sl"},{name:"Serbian",value:"sr"},{name:"Swedish",value:"sv"},{name:"Tetum",value:"tet"},{name:"Turkish",value:"tr"},{name:"Ukrainian",value:"uk"},{name:"Chinese",value:"zh"}],this.current.jsonData.unit=this.current.jsonData.unit||"si",this.current.jsonData.language=this.current.jsonData.language||"en"}t.DarkSkyConfigCtrl=r},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/query.options.html",n);function n(e){console.debug("DarkSkyQueryOptionsCtrl")}t.DarkskyQueryOptionsCtrl=r},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/annotations.editor.html",n);function n(e){console.debug("DarkSkyAnnotationCtrl")}t.DarkSkyAnnotationCtrl=r}],a.c=n,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(r,n,function(t){return e[t]}.bind(null,n));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0);function a(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,a),t.l=!0,t.exports}var r,n}));
//# sourceMappingURL=module.js.map