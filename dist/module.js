define(["lodash","app/plugins/sdk"],(function(t,e){return n={},a.m=r=[function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AnnotationsQueryCtrl=e.QueryOptionsCtrl=e.ConfigCtrl=e.QueryCtrl=e.Datasource=void 0;var r=a(1),n=a(3),u=a(5),i=a(6),o=a(7);e.Datasource=r.DarkSkyDatasource,e.QueryCtrl=n.DarkSkyQueryCtrl,e.ConfigCtrl=u.DarkSkyConfigCtrl,e.QueryOptionsCtrl=i.DarkskyQueryOptionsCtrl,e.AnnotationsQueryCtrl=o.DarkSkyAnnotationCtrl},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkSkyDatasource=void 0;var r,n=(r=a(2))&&r.__esModule?r:{default:r},u=(i.$inject=["instanceSettings","backendSrv","templateSrv","$q"],i.prototype.metricFindQuery=function(t){var e=this;return this.metrics?this.metrics:this.doRequest({data:t}).then((function(t){var a=n.default.transform(["currently","hourly","daily"],(function(e,a){var r=t.data[a];r&&n.default.isArray(r.data)&&(r=r.data.length?r.data[0]:{}),e.push.apply(e,n.default.filter(n.default.keys(r),(function(t){return"time"!=t})))}),[]);return e.metrics=n.default.map(n.default.uniq(n.default.sortBy(a)),(function(t){return{text:t,value:t}})),e.metrics}))},i.prototype.query=function(t){var e=this,a=this.buildQueryParameters(t);if(a.targets=a.targets.filter((function(t){return!t.hide})),a.targets.length<=0)return this.$q.when({data:[]});this.templateSrv.getAdhocFilters?a.adhocFilters=this.templateSrv.getAdhocFilters(this.datasourceName):a.adhocFilters=[];var r=this.getApiCalls(a.range,a.maxDataPoints),u=this.lon,i=this.lat;t&&t.targets&&(u=t.targets[0].lon,i=t.targets[0].lat);var o=this.apiUrl+"/"+i+","+u,s=n.default.map(r.timestamps,(function(t){return e.doRequest({url:o+","+t+"?"+e.apiOptions,data:a})}));return 10<=r.timestamps.length&&console.warn("DarkSky will execute "+r.timestamps.length+" api."),Promise.all(s).then((function(t){var u=n.default.transform(t,(function(t,e){var u=n.default.get(e,"data."+r.dataset);"currently"!=r.dataset?t.push.apply(t,n.default.filter(u.data,(function(t){var e=1e3*t.time;return e>=a.range.from&&e<=a.range.to}))):t.push(u)}),[]);return u=n.default.sortBy(u,"time"),n.default.filter(a.targets,{type:"table"}).length?e.tableResponse(a.targets,u):e.timeseriesResponse(a.targets,u)}))},i.prototype.getApiCalls=function(t,e){var a="hourly",r=1,n=t.to.diff(t.from,"hours"),u=t.from.clone().startOf("day"),i=[u.unix()];if(t.to.date()!==t.from.date()){if(168<n&&(a="daily",e)){var o=t.to.diff(t.from,"days");r=Math.max(r,Math.floor(o/e))}for(u.add(r,"day");u.isBefore(t.to);)i.push(u.unix()),u.add(r,"day")}return{dataset:a,timestamps:i}},i.prototype.tableResponse=function(t,e){t[0].target;var a=n.default.map(n.default.head(e),(function(t,e){return{text:e,type:e.match(/[Tt]ime/)?"time":"string"==typeof t?"string":"number"}})),r=n.default.map(e,(function(t){return n.default.map(a,(function(e){return void 0===t[e.text]?null:"time"==e.type?1e3*t[e.text]:t[e.text]}))}));return{data:[{type:"table",columns:a,rows:r}]}},i.prototype.timeseriesResponse=function(t,e){return{data:n.default.map(t,(function(t){return{target:t.target,datapoints:n.default.map(e,(function(e){return[e[t.target],1e3*e.time]}))}}))}},i.prototype.buildQueryParameters=function(t){var e=this;return t.targets=n.default.filter(t.targets,(function(t){return"select metric"!==t.target})),t.targets=n.default.map(t.targets,(function(a){return{target:e.templateSrv.replace(a.target,t.scopedVars,"regex"),refId:a.refId,hide:a.hide,type:a.type,lon:a.lon,lat:a.lat}})),t},i.prototype.testDatasource=function(){return this.doRequest({}).then((function(t){return 200===t.status?{status:"success",message:"Data source is working",title:"Success"}:{status:"error",message:"Data source returned status "+t.status,title:"Error"}}))},i.prototype.doRequest=function(t){var e=this.apiUrl+"/"+this.lon+","+this.lat;return t&&t.url&&(e=t.url),this.backendSrv.datasourceRequest(n.default.assign({url:e,method:"GET"},t)).then((function(t){var e=n.default.get(t.headers(),"x-forecast-api-calls");return 400<e&&console.warn("DarkSky noticed you've already executed "+e+" api calls. Free limit is 1000."),t}))},i.prototype.annotationQuery=function(t){throw new Error("Annotation Support not implemented yet.")},i);function i(t,e,a,r){this.backendSrv=e,this.templateSrv=a,this.$q=r,this.datasourceName=t.name;var n=t.jsonData;this.lat=n.lat,this.lon=n.lon;var u=""+n.apikey;this.apiUrl="/api/datasources/proxy/"+t.id+"/darksky/"+u,this.apiOptions="units="+n.unit+"&lang="+n.language}e.DarkSkyDatasource=u},function(e,a){e.exports=t},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkSkyQueryCtrl=void 0;var r,n,u=a(4),i=((r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)},function(t,e){function a(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)})(o,n=u.QueryCtrl),o.$inject=["$scope","$injector","templateSrv"],o.prototype.getOptions=function(t){return this.datasource.metricFindQuery(this.target.type)},o.prototype.refresh=function(){this.panelCtrl.refresh()},o.templateUrl="partials/query.editor.html",o);function o(t,e,a){var r=n.call(this,t,e)||this;return r.templateSrv=a,r.types=[{text:"Time series",value:"timeseries"},{text:"Table",value:"table"}],r.target.target=r.target.target||"select metric",r.target.type=r.target.type||("table"===r.panelCtrl.panel.type?"table":"timeseries"),r.target.lon=r.target.lon||r.datasource.lon,r.target.lat=r.target.lat||r.datasource.lat,r}e.DarkSkyQueryCtrl=i},function(t,a){t.exports=e},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/config.html",n);function n(t){console.debug("DarkSkyConfigCtrl"),this.units=[{name:"SI",value:"si"},{name:"Auto",value:"auto"},{name:"US",value:"us"},{name:"CA",value:"ca"},{name:"UK",value:"uk2"}],this.languages=[{name:"Arabic",value:"ar"},{name:"Azerbaijani",value:"az"},{name:"Belarusian",value:"be"},{name:"Bulgarian",value:"bg"},{name:"Bosnian",value:"bs"},{name:"Catalan",value:"ca"},{name:"Czech",value:"cs"},{name:"Danish",value:"da"},{name:"German",value:"de"},{name:"Greek",value:"el"},{name:"English",value:"en"},{name:"Spanish",value:"es"},{name:"Estonian",value:"et"},{name:"Finnish",value:"fi"},{name:"French",value:"fr"},{name:"Hebrew",value:"he"},{name:"Croatian",value:"hr"},{name:"Hungarian",value:"hu"},{name:"Indonesian",value:"id"},{name:"Icelandic",value:"is"},{name:"Italian",value:"it"},{name:"Japanese",value:"ja"},{name:"Georgian",value:"ka"},{name:"Korean",value:"ko"},{name:"Cornish",value:"kw"},{name:"Norwegian",value:"nb"},{name:"Dutch",value:"nl"},{name:"Polish",value:"pl"},{name:"Portuguese",value:"pt"},{name:"Romanian",value:"ro"},{name:"Russian",value:"ru"},{name:"Slovak",value:"sk"},{name:"Slovenian",value:"sl"},{name:"Serbian",value:"sr"},{name:"Swedish",value:"sv"},{name:"Tetum",value:"tet"},{name:"Turkish",value:"tr"},{name:"Ukrainian",value:"uk"},{name:"Chinese",value:"zh"}],this.current.jsonData.unit=this.current.jsonData.unit||"si",this.current.jsonData.language=this.current.jsonData.language||"en"}e.DarkSkyConfigCtrl=r},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/query.options.html",n);function n(t){console.debug("DarkSkyQueryOptionsCtrl")}e.DarkskyQueryOptionsCtrl=r},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=(n.$inject=["$scope"],n.templateUrl="partials/annotations.editor.html",n);function n(t){console.debug("DarkSkyAnnotationCtrl")}e.DarkSkyAnnotationCtrl=r}],a.c=n,a.d=function(t,e,r){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(r,n,function(e){return t[e]}.bind(null,n));return r},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s=0);function a(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,a),e.l=!0,e.exports}var r,n}));
//# sourceMappingURL=module.js.map