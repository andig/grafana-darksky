define(["lodash","app/plugins/sdk"],function(e,t){return function(e){var t={};function a(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=e,a.c=t,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(r,n,function(t){return e[t]}.bind(null,n));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigCtrl=t.QueryCtrl=t.Datasource=void 0;var r=a(1),n=a(3),u=a(5);t.Datasource=r.DarkSkyDatasource,t.QueryCtrl=n.DarkSkyQueryCtrl,t.ConfigCtrl=u.DarkSkyConfigCtrl},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DarkSkyDatasource=void 0;var r=function(e){return e&&e.__esModule?e:{default:e}}(a(2));var n=function(){function e(e,t,a,r){this.backendSrv=t,this.templateSrv=a,this.$q=r,this.datasourceName=e.name;var n=e.jsonData,u=n.apikey+"/"+n.lat+","+n.lon;this.apiUrl="/api/datasources/proxy/"+e.id+"/darksky/"+u,this.apiOptions="units="+n.unit+"&lang="+n.language}return e.$inject=["instanceSettings","backendSrv","templateSrv","$q"],e.prototype.metricFindQuery=function(e){var t=this;return this.metrics?this.metrics:this.doRequest({data:e}).then(function(e){var a=r.default.transform(["currently","hourly","daily"],function(t,a){var n=e.data[a];n&&r.default.isArray(n.data)&&(n=n.data.length?n.data[0]:{}),t.push.apply(t,r.default.filter(r.default.keys(n),function(e){return"time"!=e}))},[]);return t.metrics=r.default.map(r.default.uniq(r.default.sortBy(a)),function(e){return{text:e,value:e}}),t.metrics})},e.prototype.query=function(e){var t=this,a=this.buildQueryParameters(e);if(a.targets=a.targets.filter(function(e){return!e.hide}),a.targets.length<=0)return this.$q.when({data:[]});this.templateSrv.getAdhocFilters?a.adhocFilters=this.templateSrv.getAdhocFilters(this.datasourceName):a.adhocFilters=[];var n=this.getApiCalls(a.range,a.maxDataPoints),u=r.default.map(n.timestamps,function(e){return t.doRequest({url:t.apiUrl+","+e+"?"+t.apiOptions,data:a})});return n.timestamps.length>=10&&console.warn("DarkSky will execute "+n.timestamps.length+" api."),Promise.all(u).then(function(e){var u=r.default.transform(e,function(e,t){var u=r.default.get(t,"data."+n.dataset);"currently"!=n.dataset?e.push.apply(e,r.default.filter(u.data,function(e){var t=1e3*e.time;return t>=a.range.from&&t<=a.range.to})):e.push(u)},[]);return u=r.default.sortBy(u,"time"),r.default.filter(a.targets,{type:"table"}).length?t.tableResponse(a.targets,u):t.timeseriesResponse(a.targets,u)})},e.prototype.getApiCalls=function(e,t){var a="hourly",r=1,n=e.to.diff(e.from,"hours"),u=e.from.clone().startOf("day"),i=[u.unix()];if(e.to.date()!==e.from.date()){if(n>168&&(a="daily",t)){var o=e.to.diff(e.from,"days");r=Math.max(r,Math.floor(o/t))}for(u.add(r,"day");u.isBefore(e.to);)i.push(u.unix()),u.add(r,"day")}return{dataset:a,timestamps:i}},e.prototype.tableResponse=function(e,t){e[0].target;var a=r.default.map(r.default.head(t),function(e,t){return{text:t,type:t.match(/[Tt]ime/)?"time":"string"==typeof e?"string":"number"}}),n=r.default.map(t,function(e){return r.default.map(a,function(t){return void 0===e[t.text]?null:"time"==t.type?1e3*e[t.text]:e[t.text]})});return{data:[{type:"table",columns:a,rows:n}]}},e.prototype.timeseriesResponse=function(e,t){return{data:r.default.map(e,function(e){return{target:e.target,datapoints:r.default.map(t,function(t){return[t[e.target],1e3*t.time]})}})}},e.prototype.buildQueryParameters=function(e){var t=this;return e.targets=r.default.filter(e.targets,function(e){return"select metric"!==e.target}),e.targets=r.default.map(e.targets,function(a){return{target:t.templateSrv.replace(a.target,e.scopedVars,"regex"),refId:a.refId,hide:a.hide,type:a.type}}),e},e.prototype.testDatasource=function(){return this.doRequest({}).then(function(e){return 200==e.status?{status:"success",message:"Data source is working",title:"Success"}:{status:"error",message:"Data source returned status "+e.status,title:"Error"}})},e.prototype.doRequest=function(e){return this.backendSrv.datasourceRequest(r.default.assign({url:this.apiUrl,method:"GET"},e)).then(function(e){var t=r.default.get(e.headers(),"x-forecast-api-calls");return t>400&&console.warn("DarkSky noticed you've already executed "+t+" api calls. Free limit is 1000."),e})},e.prototype.annotationQuery=function(e){return[]},e}();t.DarkSkyDatasource=n},function(t,a){t.exports=e},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DarkSkyQueryCtrl=void 0;var r=a(4),n=function(){var e=function(t,a){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(t,a)};return function(t,a){function r(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}(),u=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.templateSrv=r,n.types=[{text:"Time series",value:"timeseries"},{text:"Table",value:"table"}],n.target.target=n.target.target||"select metric",n.target.type=n.target.type||("table"===n.panelCtrl.panel.type?"table":"timeseries"),n}return n(t,e),t.$inject=["$scope","$injector","templateSrv"],t.prototype.getOptions=function(e){return this.datasource.metricFindQuery(this.target.type)},t.prototype.refresh=function(){this.panelCtrl.refresh()},t.templateUrl="partials/query.editor.html",t}(r.QueryCtrl);t.DarkSkyQueryCtrl=u},function(e,a){e.exports=t},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){console.log("DarkSkyConfigCtrl"),console.log(e),console.log(this),this.units=[{name:"SI",value:"si"},{name:"Auto",value:"auto"},{name:"US",value:"us"},{name:"CA",value:"ca"},{name:"UK",value:"uk2"}],this.languages=[{name:"Arabic",value:"ar"},{name:"Azerbaijani",value:"az"},{name:"Belarusian",value:"be"},{name:"Bulgarian",value:"bg"},{name:"Bosnian",value:"bs"},{name:"Catalan",value:"ca"},{name:"Czech",value:"cs"},{name:"Danish",value:"da"},{name:"German",value:"de"},{name:"Greek",value:"el"},{name:"English",value:"en"},{name:"Spanish",value:"es"},{name:"Estonian",value:"et"},{name:"Finnish",value:"fi"},{name:"French",value:"fr"},{name:"Hebrew",value:"he"},{name:"Croatian",value:"hr"},{name:"Hungarian",value:"hu"},{name:"Indonesian",value:"id"},{name:"Icelandic",value:"is"},{name:"Italian",value:"it"},{name:"Japanese",value:"ja"},{name:"Georgian",value:"ka"},{name:"Korean",value:"ko"},{name:"Cornish",value:"kw"},{name:"Norwegian",value:"nb"},{name:"Dutch",value:"nl"},{name:"Polish",value:"pl"},{name:"Portuguese",value:"pt"},{name:"Romanian",value:"ro"},{name:"Russian",value:"ru"},{name:"Slovak",value:"sk"},{name:"Slovenian",value:"sl"},{name:"Serbian",value:"sr"},{name:"Swedish",value:"sv"},{name:"Tetum",value:"tet"},{name:"Turkish",value:"tr"},{name:"Ukrainian",value:"uk"},{name:"Chinese",value:"zh"}],this.current.jsonData.unit=this.current.jsonData.unit||"si",this.current.jsonData.language=this.current.jsonData.language||"en"}return e.$inject=["$scope"],e.templateUrl="partials/config.html",e}();t.DarkSkyConfigCtrl=r}])});
//# sourceMappingURL=module.js.map